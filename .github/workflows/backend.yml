name: Backend CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set commit SHA as image tag
      - name: Set image tag
        run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 3️⃣ SonarQube scan
      - name: SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          organization: "your-org"        # اسم organization في SonarCloud
          projectKey: "bookstore-backend" # مفتاح المشروع
          projectName: "Bookstore Backend"
          token: ${{ secrets.SONAR_TOKEN }}

      # 4️⃣ Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5️⃣ Build backend Docker image
      - name: Build backend Docker image
        run: |
          docker build \
            -t kenzyehab/bookstore-backend:${IMAGE_TAG} \
            backend

      # 6️⃣ Security scan with Trivy
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: kenzyehab/bookstore-backend:${IMAGE_TAG}
          severity: HIGH,CRITICAL
          exit-code: 1
          format: 'json'
          output: 'security-reports/backend-trivy-report.json'

      # 7️⃣ Upload Security Reports
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-reports
          path: security-reports/

      # 8️⃣ Push Docker image
      - name: Push Docker image
        run: docker push kenzyehab/bookstore-backend:${IMAGE_TAG}
