name: Frontend CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"

jobs:
  frontend:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set commit SHA as image tag
      - name: Set image tag
        run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 3️⃣ Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4️⃣ Build frontend Docker image
      - name: Build frontend Docker image
        run: |
          docker build \
            -t kenzyehab/bookstore-frontend:${IMAGE_TAG} \
            frontend

      # 5️⃣ SonarQube Scan
      - name: SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          organization: "your-org"
          projectKey: "bookstore-frontend"
          projectName: "Bookstore Frontend"
          token: ${{ secrets.SONAR_TOKEN }}

      # 6️⃣ Security scan with Trivy
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: kenzyehab/bookstore-frontend:${IMAGE_TAG}
          severity: HIGH,CRITICAL
          exit-code: 1
          format: 'json'
          output: 'security/frontend-trivy-report.json'

      # 7️⃣ Upload Security Reports
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-reports
          path: security/

      # 8️⃣ Push Docker image
      - name: Push Docker image
        run: docker push kenzyehab/bookstore-frontend:${IMAGE_TAG}
